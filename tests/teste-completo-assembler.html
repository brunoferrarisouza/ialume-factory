<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume - Jogo Educativo</title>
    <style>
        /* ===== PALETA LUME ===== */
:root {
    --lume-primary: #ffd700;
    --lume-glow: #fff8dc;
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --correct: #51cf66;
    --wrong: #ff6b6b;
}

/* ===== RESET ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--primary-gradient);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

/* ===== CONTAINER ===== */
.game-container {
    background: white;
    border-radius: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 800px;
    width: 100%;
    min-height: 500px;
    overflow: hidden;
    position: relative;
}

/* ===== HEADER ===== */
.header {
    background: linear-gradient(to bottom, #fff, #f8f9fa);
    padding: 20px;
    text-align: center;
    border-bottom: 2px solid #dee2e6;
}

#phase-title {
    color: #212529;
    font-size: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* ===== CONTEÚDO ===== */
#content-area {
    padding: 40px;
    text-align: center;
}

.phase {
    display: none;
}

.phase.active {
    display: block;
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== LUME (flutua) ===== */
.lume-char {
    font-size: 6rem;
    display: inline-block;
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 0 30px var(--lume-glow));
    margin-bottom: 20px;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

/* ===== STORY BOX ===== */
.story-box {
    background: rgba(102, 126, 234, 0.1);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
}

.story-box h1 {
    color: #212529;
    font-size: 2rem;
    margin-bottom: 15px;
}

.story-box p {
    font-size: 1.2rem;
    color: #6c757d;
    line-height: 1.8;
}

/* ===== QUESTION BOX ===== */
.question-box {
    background: rgba(102, 126, 234, 0.05);
    border: 2px solid #dee2e6;
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
}

.question-box h2 {
    color: #212529;
    font-size: 1.8rem;
    margin-bottom: 20px;
}

.question-box p {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 20px;
}

/* ===== BOTÕES ===== */
.btn {
    padding: 15px 40px;
    font-size: 1.1rem;
    font-weight: bold;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.btn:active {
    transform: translateY(-1px);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

/* ===== FEEDBACK ===== */
#feedback-zone {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 20px 30px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 1.1rem;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.5s ease;
    z-index: 1000;
}

#feedback-zone.show {
    opacity: 1;
    transform: translateX(0);
}

#feedback-zone.correct {
    background: var(--correct);
    color: white;
}

#feedback-zone.wrong {
    background: var(--wrong);
    color: white;
}

/* ===== SCORE ===== */
.score-container {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    padding: 15px 20px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.score-item {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
    font-weight: bold;
    color: #212529;
}

.score-item:last-child {
    margin-bottom: 0;
}

#score, #correct-count {
    color: var(--lume-primary);
    transition: transform 0.2s;
}

/* ===== RESPONSIVO ===== */
@media (max-width: 768px) {
    .game-container {
        border-radius: 15px;
        min-height: 400px;
    }
    
    .lume-char {
        font-size: 4rem;
    }
    
    #content-area {
        padding: 20px;
    }
    
    .story-box, .question-box {
        padding: 25px;
    }
    
    .story-box h1, .question-box h2 {
        font-size: 1.5rem;
    }
    
    .btn {
        padding: 12px 30px;
        font-size: 1rem;
    }
    
    .score-container {
        top: 10px;
        left: 10px;
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    #feedback-zone {
        top: 10px;
        right: 10px;
        padding: 15px 20px;
        font-size: 1rem;
    }
}

    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="header">
            <h1 id="phase-title">BEM-VINDO!</h1>
        </div>

        <!-- Score -->
        <div class="score-container">
            <div class="score-item">
                Pontos: <span id="score">0</span>
            </div>
            <div class="score-item">
                Acertos: <span id="correct-count">0</span>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <!-- Fase 0: Boas-vindas -->
            <div id="phase-0" class="phase active">
                <div class="lume-char">🌟</div>
                <div class="story-box">
                    <h1>🧪 Teste Completo - IAlume Factory</h1>
                    <p>Teste integrado: 4 modalidades + escalada + Bubble + callback central</p>
                    <button class="btn btn-primary" onclick="startAdventure()">
                        COMEÇAR AVENTURA
                    </button>
                </div>
            </div>

            <!-- Fases dinâmicas -->
            
            <!-- Fase 1 -->
            <div id="phase-1" class="phase">
                <!-- Conteúdo será injetado dinamicamente pelo Game Engine -->
            </div>
            
            <!-- Fase 2 -->
            <div id="phase-2" class="phase">
                <!-- Conteúdo será injetado dinamicamente pelo Game Engine -->
            </div>
            
            <!-- Fase 3 -->
            <div id="phase-3" class="phase">
                <!-- Conteúdo será injetado dinamicamente pelo Game Engine -->
            </div>
            
            <!-- Fase 4 -->
            <div id="phase-4" class="phase">
                <!-- Conteúdo será injetado dinamicamente pelo Game Engine -->
            </div>
            
            <!-- Fase 5 -->
            <div id="phase-5" class="phase">
                <!-- Conteúdo será injetado dinamicamente pelo Game Engine -->
            </div>
            
        </div>

        <!-- Feedback Zone -->
        <div id="feedback-zone"></div>
    </div>

    <script>
        
            // ========== BASE SCRIPTS ==========
            
// ===== base.js =====
// ESTADO DO JOGO
let gameState = {
    currentPhase: 0,
    score: 0,
    correctAnswers: 0,
    startTime: Date.now(),
    totalPhases: 4
};

// WEB AUDIO API
let audioContext;

function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function playSound(type) {
    initAudio();
    
    const frequencies = {
        success: [523.25, 659.25, 783.99],
        error: [349.23, 293.66],
        victory: [523.25, 659.25, 783.99, 1046.50],
        click: [440]
    };
    
    const notes = frequencies[type] || frequencies.click;
    
    notes.forEach((freq, index) => {
        setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
        }, index * 100);
    });
}

// NAVEGACAO ENTRE FASES
function goToPhase(phaseNumber) {
    const phases = document.querySelectorAll('.phase');
    phases.forEach(phase => {
        phase.classList.remove('active');
    });
    
    const targetPhase = document.getElementById('phase-' + phaseNumber);
    if (targetPhase) {
        targetPhase.classList.add('active');
        gameState.currentPhase = phaseNumber;
        updatePhaseTitle(phaseNumber);
    } else {
        console.error('Fase ' + phaseNumber + ' nao encontrada!');
    }
}

function updatePhaseTitle(phaseNumber) {
    const titleElement = document.getElementById('phase-title');
    const titles = [
        'BEM-VINDO!',
        'FASE 1: DESCOBERTA',
        'FASE 2: COMPREENSAO',
        'FASE 3: APLICACAO',
        'FASE 4: CRIACAO'
    ];
    
    if (titleElement && titles[phaseNumber]) {
        titleElement.textContent = titles[phaseNumber];
    }
}

// FEEDBACK VISUAL
function showFeedback(message, type) {
    const feedbackZone = document.getElementById('feedback-zone');
    
    feedbackZone.textContent = message;
    feedbackZone.className = 'feedback ' + type + ' show';
    
    playSound(type === 'correct' ? 'success' : 'error');
    
    setTimeout(() => {
        feedbackZone.classList.remove('show');
    }, 3000);
}

// SISTEMA DE SCORE
function addScore(points) {
    gameState.score += points;
    const scoreElement = document.getElementById('score');
    if (scoreElement) {
        scoreElement.textContent = gameState.score;
        scoreElement.style.transform = 'scale(1.5)';
        setTimeout(() => {
            scoreElement.style.transform = 'scale(1)';
        }, 200);
    }
}

function incrementCorrect() {
    gameState.correctAnswers++;
    const correctElement = document.getElementById('correct-count');
    if (correctElement) {
        correctElement.textContent = gameState.correctAnswers;
    }
}

// ===== CALLBACK CENTRAL PARA TODAS AS MODALIDADES =====
/**
 * Função centralizada chamada por TODAS as modalidades quando o usuário responde.
 * Esta é a PONTE entre modalidades, mecânicas e Game Engine.
 *
 * FLUXO:
 * 1. Registra resultado no GAME_ENGINE (para estatísticas finais)
 * 2. Atualiza UI de score (pontos e acertos)
 * 3. Dispara feedback visual da mecânica (escalada, corrida, etc)
 * 4. Avança para próxima fase após delay
 *
 * @param {boolean} isCorrect - Se a resposta está correta
 * @param {number} phaseNumber - Número da fase (1, 2, 3, 4, etc)
 */
function onAnswerChecked(isCorrect, phaseNumber) {
    console.log('🎯 onAnswerChecked chamado:', {
        isCorrect: isCorrect,
        phaseNumber: phaseNumber,
        timestamp: new Date().toISOString()
    });

    // 1️⃣ REGISTRAR NO GAME ENGINE (SEMPRE!)
    // Isso garante que os dados estarão disponíveis em getFinalResult()
    const points = isCorrect ? 100 : 0;

    if (window.GAME_ENGINE && typeof GAME_ENGINE.recordResult === 'function') {
        GAME_ENGINE.recordResult(phaseNumber, isCorrect, points);
        console.log('✅ Resultado registrado no Game Engine');
    } else {
        console.warn('⚠️ GAME_ENGINE.recordResult() não encontrado! Dados não serão salvos.');
    }

    // 2️⃣ ATUALIZAR UI DE SCORE (gameState local + elementos DOM)
    if (isCorrect) {
        addScore(points);
        incrementCorrect();
        console.log('📊 Score atualizado:', gameState.score, 'pontos,', gameState.correctAnswers, 'acertos');
    }

    // 3️⃣ FEEDBACK VISUAL DA MECÂNICA (se existir)
    // Suporta múltiplas mecânicas: escalada, corrida, labirinto, etc
    if (window.ESCALADA) {
        console.log('🏔️ Acionando mecânica ESCALADA');
        if (isCorrect) {
            ESCALADA.onCorrect();
        } else {
            ESCALADA.onWrong();
        }
    } else if (window.CORRIDA) {
        console.log('🏃 Acionando mecânica CORRIDA');
        if (isCorrect) {
            CORRIDA.onCorrect();
        } else {
            CORRIDA.onWrong();
        }
    } else if (window.LABIRINTO) {
        console.log('🌀 Acionando mecânica LABIRINTO');
        if (isCorrect) {
            LABIRINTO.onCorrect();
        } else {
            LABIRINTO.onWrong();
        }
    } else {
        // Sem mecânica = jogo linear simples
        console.log('⏭️  Sem mecânica visual (modo linear)');
    }

    // 4️⃣ PRÓXIMA FASE (após delay para animações)
    const delay = isCorrect ? 2500 : 3000;
    console.log('⏱️ Avançando para próxima fase em', delay, 'ms');

    setTimeout(() => {
        nextPhase();
    }, delay);
}

// Expor globalmente para as modalidades
window.onAnswerChecked = onAnswerChecked;

// ACOES DO JOGO - CORRIGIDO
function startAdventure() {
    playSound('click');
    console.log('🚀 Aventura iniciada!');
    
    // Escalada já foi inicializada pelo Game Engine
    // Apenas ir para fase 1
    setTimeout(() => {
        goToPhase(1);
    }, 1500);
}

function nextPhase() {
    playSound('click');
    const nextPhaseNumber = gameState.currentPhase + 1;
    
    console.log('nextPhase chamado. Fase atual:', gameState.currentPhase, 'Proxima:', nextPhaseNumber);
    console.log('totalPhases:', gameState.totalPhases);
    
    if (nextPhaseNumber <= gameState.totalPhases) {
        // Apenas ir para próxima fase (o quiz já subiu o Lume)
        goToPhase(nextPhaseNumber);
    } else {
        console.log('Fim do jogo! Chamando GAME_ENGINE.finish()...');
        
        // USAR GAME_ENGINE.finish() em vez de showVictory()
        setTimeout(function() {
            if (window.GAME_ENGINE && typeof GAME_ENGINE.finish === 'function') {
                GAME_ENGINE.finish();
            } else {
                // Fallback: se GAME_ENGINE não existir, usar showVictory
                console.warn('⚠️ GAME_ENGINE.finish() não encontrado, usando showVictory()');
                showVictory();
            }
        }, 1000);
    }
}

function showVictory() {
    playSound('victory');
    
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none';
    }
    
    const gameContainer = document.querySelector('.game-container');
    
    const victoryHTML = `
        <div id="victory-overlay" style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        ">
            <div style="
                background: white;
                border-radius: 30px;
                padding: 40px 50px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                text-align: center;
                max-width: 600px;
                animation: scaleIn 0.5s ease;
            ">
                <div style="font-size: 5rem; margin-bottom: 15px;">
                    🏆
                </div>
                <h1 style="
                    font-size: 2.5rem;
                    color: #ffd700;
                    margin-bottom: 15px;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
                ">
                    VITORIA!
                </h1>
                <p style="
                    font-size: 1.3rem;
                    color: #212529;
                    margin-bottom: 25px;
                ">
                    Voce completou todas as fases!
                </p>
                <div style="
                    background: rgba(102, 126, 234, 0.1);
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 25px;
                ">
                    <div style="margin-bottom: 15px;">
                        <span style="font-size: 1.2rem; font-weight: bold;">Pontos finais:</span>
                        <span style="font-size: 2rem; color: #ffd700; margin-left: 10px;">
                            ${gameState.score}
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 1.2rem; font-weight: bold;">Acertos:</span>
                        <span style="font-size: 2rem; color: #51cf66; margin-left: 10px;">
                            ${gameState.correctAnswers}
                        </span>
                    </div>
                </div>
                <button onclick="location.reload()" style="
                    padding: 20px 50px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    border-radius: 50px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    transition: transform 0.3s ease;
                ">
                    JOGAR NOVAMENTE
                </button>
            </div>
        </div>
        
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes scaleIn {
                from { transform: scale(0.8); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            #victory-overlay button:hover {
                transform: translateY(-3px) scale(1.05);
            }
        </style>
    `;
    
    gameContainer.insertAdjacentHTML('beforeend', victoryHTML);
    
    console.log('Jogo completo!');
    console.log('Score final:', gameState.score);
    console.log('Acertos:', gameState.correctAnswers);
}

function concludeGame() {
    console.log('Concluindo jogo...');
    
    if (window.ESCALADA && ESCALADA.currentStep < ESCALADA.totalSteps - 1) {
        console.log('Subindo Lume para o topo...');
        ESCALADA.climb();
        
        setTimeout(() => {
            showVictory();
        }, 1500);
    } else {
        console.log('Lume ja esta no topo!');
        showVictory();
    }
}

// VALIDACAO DE RESPOSTA GENERICA
function checkAnswer(userAnswer, correctAnswer, tolerance) {
    tolerance = tolerance || 0;
    let isCorrect = false;
    
    if (typeof userAnswer === 'number' && typeof correctAnswer === 'number') {
        isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
    } else {
        isCorrect = userAnswer === correctAnswer;
    }
    
    if (isCorrect) {
        showFeedback('Correto! Muito bem!', 'correct');
        addScore(100);
        incrementCorrect();
        
        if (window.ESCALADA) {
            ESCALADA.onCorrect();
        }
        
        setTimeout(() => {
            nextPhase();
        }, 2000);
    } else {
        showFeedback('Ops! Tente novamente.', 'wrong');
        
        if (window.ESCALADA) {
            ESCALADA.onWrong();
        }
    }
    
    return isCorrect;
}
// TESTE GIT - linha adicionada


// ===== game-engine.js =====
// ===== MOTOR DO JOGO - GAME ENGINE (VERSÃO FINAL CORRIGIDA) =====

const GAME_ENGINE = {
    config: null,
    currentPhaseIndex: 0,
    results: [],
    
    // Inicializar jogo com configuração
    init: function(gameConfig) {
        console.log('🎮 Iniciando Game Engine...', gameConfig);
        
        this.config = gameConfig;
        this.currentPhaseIndex = 0;
        this.results = [];
        
        // Validar configuração
        if (!this.validateConfig(gameConfig)) {
            console.error('❌ Configuração inválida!');
            return false;
        }
        
        // Configurar sistema base
        window.totalPhases = gameConfig.fases.length;
        
        // CORREÇÃO DEFINITIVA: Total de andares = número de fases
        // O array fases[] JÁ inclui a fase 0 (boas-vindas), então NÃO soma +1
        const totalSteps = gameConfig.fases.length;
        
        console.log('📊 Total de fases no array:', gameConfig.fases.length);
        console.log('🏔️ Total de andares na escalada:', totalSteps);
        console.log('✅ Cálculo correto: fases.length =', totalSteps, '(fase 0 já está incluída)');
        
        // Configurar mecânica (se existir e não for 'none') - ANTES de injetar fases
        if (gameConfig.mecanica && gameConfig.mecanica !== 'none') {
            const Mechanic = this.getMechanic(gameConfig.mecanica);
            if (Mechanic) {
                console.log('🎮 Inicializando mecânica:', gameConfig.mecanica);
                Mechanic.init({
                    totalSteps: totalSteps
                });
            } else {
                console.warn('⚠️ Mecânica não encontrada:', gameConfig.mecanica);
            }
        } else {
            console.log('⏭️  Jogo linear (sem mecânica visual)');
        }
        
        // Injetar todas as fases
        this.injectAllPhases();
        
        console.log('✅ Game Engine inicializado!');
        return true;
    },
    
    // Validar configuração
    validateConfig: function(config) {
        if (!config) {
            console.error('Config é null/undefined');
            return false;
        }
        
        if (!config.fases || !Array.isArray(config.fases)) {
            console.error('Fases não é um array');
            return false;
        }
        
        if (config.fases.length === 0) {
            console.error('Nenhuma fase definida');
            return false;
        }
        
        // Validar cada fase
        for (let i = 0; i < config.fases.length; i++) {
            const fase = config.fases[i];
            
            // ✅ PULAR FASE 0 (boas-vindas) - Ela é estática no HTML
            if (i === 0 && (fase.type === 'welcome' || !fase.modalidade)) {
                console.log('⏭️ Fase 0 (boas-vindas) detectada - pulando validação');
                continue;
            }
            
            if (!fase.modalidade) {
                console.error('Fase ' + (i+1) + ' sem modalidade');
                return false;
            }
            
            if (!this.getModalidade(fase.modalidade)) {
                console.error('Modalidade não existe: ' + fase.modalidade);
                return false;
            }
        }
        
        return true;
    },
    
    // Injetar todas as fases
    injectAllPhases: function() {
        console.log('📦 Injetando fases...');
        
        let numeroFase = 1; // ✅ Contador separado começa em 1
        
        this.config.fases.forEach((faseConfig, index) => {
            // ✅ PULAR FASE 0 (boas-vindas) - Ela já está no HTML
            if (index === 0 && (faseConfig.type === 'welcome' || !faseConfig.modalidade)) {
                console.log('⏭️ Fase 0 (boas-vindas) - usando conteúdo estático do HTML');
                return; // Pula essa fase, numeroFase continua 1
            }
            
            // ✅ Usa numeroFase (contador), não index+1
            console.log('📦 Injetando fase', index, 'no elemento phase-' + numeroFase);
            this.injectPhase(numeroFase, faseConfig);
            numeroFase++; // Incrementa só quando injeta
        });
        
        console.log('✅ Todas as fases injetadas!');
    },
    
    // Injetar uma fase específica
    injectPhase: function(numeroFase, faseConfig) {
        const faseElement = document.getElementById('phase-' + numeroFase);
        
        if (!faseElement) {
            console.error('Elemento phase-' + numeroFase + ' não encontrado!');
            return;
        }
        
        // Limpar fase
        faseElement.innerHTML = '';
        
        // Obter modalidade
        const Modalidade = this.getModalidade(faseConfig.modalidade);
        
        if (!Modalidade) {
            console.error('Modalidade não encontrada: ' + faseConfig.modalidade);
            faseElement.innerHTML = '<p style="color:red;">Erro: Modalidade não encontrada</p>';
            return;
        }
        
        // Criar UI da modalidade
        const ui = Modalidade.createUI(faseConfig.dados);
        faseElement.appendChild(ui);
        
        console.log('✅ Fase ' + numeroFase + ' injetada (' + faseConfig.modalidade + ')');
    },
    
    // Obter objeto da modalidade
    getModalidade: function(nome) {
        const modalidades = {
            'quiz': window.QUIZ,
            'true-false': window.TRUE_FALSE,
            'verdadeiro-falso': window.TRUE_FALSE,
            'fill-blanks': window.FILL_BLANKS,
            'lacunas': window.FILL_BLANKS,
            'sequence': window.SEQUENCE,
            'sequencia': window.SEQUENCE
        };
        
        return modalidades[nome.toLowerCase()];
    },
    
    // Obter objeto da mecânica
    getMechanic: function(nome) {
        const mechanics = {
            'escalada': window.ESCALADA,
            'corrida': window.CORRIDA,  // futuro
            'labirinto': window.LABIRINTO  // futuro
        };
        
        return mechanics[nome.toLowerCase()];
    },
    
    // Registrar resultado de uma fase
    recordResult: function(phaseNumber, correct, points) {
        this.results.push({
            fase: phaseNumber,
            acertou: correct,
            pontos: points,
            timestamp: new Date().toISOString()
        });
        
        console.log('📊 Resultado registrado:', this.results[this.results.length - 1]);
    },
    
    // Obter resultado final
    getFinalResult: function() {
        const totalFases = this.results.length;
        const acertos = this.results.filter(r => r.acertou).length;
        const pontosTotais = this.results.reduce((sum, r) => sum + r.pontos, 0);
        
        return {
            tema: this.config.tema || 'Sem tema',
            totalFases: totalFases,
            acertos: acertos,
            erros: totalFases - acertos,
            pontosTotais: pontosTotais,
            percentualAcerto: Math.round((acertos / totalFases) * 100),
            detalhes: this.results,
            timestamp: new Date().toISOString()
        };
    },
    
    // Finalizar jogo
    finish: function() {
        const resultado = this.getFinalResult();
        
        console.log('🏁 JOGO FINALIZADO!', resultado);
        
        // Salvar no localStorage (temporário)
        localStorage.setItem('ultimo_resultado', JSON.stringify(resultado));
        
        // Callback para Bubble (se existir)
        if (window.sendResultToBubble) {
            window.sendResultToBubble(resultado);
        }
        
        // Mostrar tela final
        this.showFinalScreen(resultado);
        
        return resultado;
    },
    
    // Mostrar tela final
    showFinalScreen: function(resultado) {
        const container = document.getElementById('phase-' + window.totalPhases);
        
        if (!container) return;
        
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; color: white;">
                <h1 style="font-size: 2.5rem; margin-bottom: 20px;">🎉 PARABÉNS!</h1>
                <h2 style="font-size: 1.8rem; margin-bottom: 30px;">${resultado.tema}</h2>
                
                <div style="background: rgba(255,255,255,0.2); border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                    <div style="font-size: 3rem; font-weight: 700; margin-bottom: 10px;">
                        ${resultado.pontosTotais} PONTOS
                    </div>
                    <div style="font-size: 1.3rem;">
                        ✅ ${resultado.acertos} acertos | ❌ ${resultado.erros} erros
                    </div>
                    <div style="font-size: 1.5rem; margin-top: 15px; font-weight: 600;">
                        ${resultado.percentualAcerto}% de aproveitamento
                    </div>
                </div>
                
                <button onclick="location.reload()" style="
                    padding: 20px 40px;
                    font-size: 1.3rem;
                    font-weight: 700;
                    background: white;
                    color: #667eea;
                    border: none;
                    border-radius: 15px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                ">
                    🔄 JOGAR NOVAMENTE
                </button>
            </div>
        `;
    }
};

// Expor globalmente
window.GAME_ENGINE = GAME_ENGINE;

console.log('🎮 game-engine.js carregado!');


// ===== questoes.js =====
// ===== BANCO DE QUESTOES =====

// QUIZ - Multipla Escolha
const QUESTOES_MATEMATICA = [
    {
        pergunta: "Quanto e 5 x 3?",
        alternativas: ["12", "15", "18", "20"],
        correta: 1,
        feedback_correto: "Perfeito! 5 x 3 = 15",
        feedback_errado: "Ops! Revise a tabuada do 5."
    },
    {
        pergunta: "Quanto e 20 / 4?",
        alternativas: ["3", "4", "5", "6"],
        correta: 2,
        feedback_correto: "Isso mesmo! 20 / 4 = 5",
        feedback_errado: "Tente dividir novamente!"
    },
    {
        pergunta: "Quanto e 8 + 7?",
        alternativas: ["13", "14", "15", "16"],
        correta: 2,
        feedback_correto: "Excelente! 8 + 7 = 15",
        feedback_errado: "Quase la! Some de novo."
    },
    {
        pergunta: "Quanto e 12 - 5?",
        alternativas: ["5", "6", "7", "8"],
        correta: 2,
        feedback_correto: "Parabens! 12 - 5 = 7",
        feedback_errado: "Revise a subtracao!"
    }
];

// VERDADEIRO OU FALSO
const QUESTOES_VERD_FALSO = [
    {
        afirmacao: "A agua ferve a 100 graus ao nivel do mar.",
        correta: true,
        feedback_correto: "Correto! A 100 graus ao nivel do mar",
        feedback_errado: "Na verdade, a agua ferve a 100 graus ao nivel do mar!"
    },
    {
        afirmacao: "O Sol gira em torno da Terra.",
        correta: false,
        feedback_correto: "Exato! A Terra gira em torno do Sol",
        feedback_errado: "Ops! A Terra que gira em torno do Sol!"
    },
    {
        afirmacao: "O coracao humano tem 4 camaras.",
        correta: true,
        feedback_correto: "Isso mesmo! 2 atrios e 2 ventriculos",
        feedback_errado: "Na verdade, o coracao tem SIM 4 camaras!"
    },
    {
        afirmacao: "A capital do Brasil e Sao Paulo.",
        correta: false,
        feedback_correto: "Correto! A capital e Brasilia",
        feedback_errado: "Ops! A capital do Brasil e Brasilia!"
    }
];

// PREENCHER LACUNAS
const QUESTOES_LACUNAS = [
    {
        frase: "O Brasil foi descoberto em ____.",
        resposta: "1500",
        variacoes_aceitas: ["1500"],
        dica: "Seculo XVI",
        feedback_correto: "Isso mesmo! Em 1500 por Pedro Alvares Cabral",
        feedback_errado: "O Brasil foi descoberto em 1500!"
    },
    {
        frase: "A capital do Brasil e ____.",
        resposta: "Brasilia",
        variacoes_aceitas: ["Brasilia", "brasilia"],
        dica: "Fica no Distrito Federal",
        feedback_correto: "Correto! Brasilia, inaugurada em 1960",
        feedback_errado: "A capital do Brasil e Brasilia!"
    },
    {
        frase: "A agua e composta por hidrogenio e ____.",
        resposta: "oxigenio",
        variacoes_aceitas: ["oxigenio", "O2"],
        dica: "H2O - O elemento O",
        feedback_correto: "Exato! H2O = 2 hidrogenios + 1 oxigenio",
        feedback_errado: "A agua e H2O: hidrogenio e oxigenio!"
    },
    {
        frase: "O maior planeta do Sistema Solar e ____.",
        resposta: "Jupiter",
        variacoes_aceitas: ["Jupiter", "jupiter"],
        dica: "Gigante gasoso",
        feedback_correto: "Isso! Jupiter e enorme!",
        feedback_errado: "O maior planeta e Jupiter!"
    }
];

// ORDENAR SEQUENCIA
const QUESTOES_SEQUENCIA = [
    {
        instrucao: "Ordene os planetas do mais proximo ao mais distante do Sol:",
        itens: ["Mercurio", "Venus", "Terra", "Marte"],
        ordem_correta: ["Mercurio", "Venus", "Terra", "Marte"],
        feedback_correto: "Perfeito! Essa e a ordem correta dos planetas!",
        feedback_errado: "Ops! Veja a ordem correta dos planetas."
    },
    {
        instrucao: "Ordene os numeros do menor para o maior:",
        itens: ["10", "3", "7", "1"],
        ordem_correta: ["1", "3", "7", "10"],
        feedback_correto: "Exato! Ordem crescente correta!",
        feedback_errado: "Quase! A ordem crescente e diferente."
    }
];

// Funcao para injetar quiz em uma fase
function injetarQuizNaFase(numeroFase, questao) {
    const fase = document.getElementById('phase-' + numeroFase);
    if (!fase) {
        console.error('Fase ' + numeroFase + ' nao encontrada!');
        return;
    }
    
    fase.innerHTML = '';
    const quizUI = QUIZ.createUI(questao);
    fase.appendChild(quizUI);
    
    console.log('Quiz injetado na Fase ' + numeroFase);
}

// Expor globalmente
window.QUESTOES_MATEMATICA = QUESTOES_MATEMATICA;
window.QUESTOES_VERD_FALSO = QUESTOES_VERD_FALSO;
window.QUESTOES_LACUNAS = QUESTOES_LACUNAS;
window.QUESTOES_SEQUENCIA = QUESTOES_SEQUENCIA;
window.injetarQuizNaFase = injetarQuizNaFase;

console.log('questoes.js carregado!');


// ===== bubble-integration.js =====
// ===== BUBBLE INTEGRATION =====
// Código de integração com Bubble.io
// Injeta CONFIG, envia resultados, auto-close

// ========== CONFIGURAÇÃO BUBBLE ==========
const BUBBLE_CONFIG = {
    bubbleApiUrl: 'https://ialume.bubbleapps.io/api/1.1',
    bubbleApiKey: '%%BUBBLE_API_KEY%%',  // Substituir no Bubble
    paginaId: null,
    sessaoId: null,
    alunoId: null
};

// ========== LER PARÂMETROS DA URL ==========
function initBubbleParams() {
    console.log('🔗 Inicializando parâmetros Bubble...');
    
    const params = getURLParams();
    console.log('📋 URL Params:', params);
    
    // Configurar IDs
    if (params.pagina_id) {
        BUBBLE_CONFIG.paginaId = params.pagina_id;
        console.log('✅ pagina_id:', BUBBLE_CONFIG.paginaId);
    }
    if (params.sessao_id) {
        BUBBLE_CONFIG.sessaoId = params.sessao_id;
        console.log('✅ sessao_id:', BUBBLE_CONFIG.sessaoId);
    }
    if (params.aluno_id) {
        BUBBLE_CONFIG.alunoId = params.aluno_id;
        console.log('✅ aluno_id:', BUBBLE_CONFIG.alunoId);
    }
    
    // Verificar API Key
    if (BUBBLE_CONFIG.bubbleApiKey.includes('%%')) {
        console.warn('⚠️ API Key não configurada! Rodando em modo demo.');
    } else {
        console.log('✅ API Key configurada');
    }
}

function getURLParams() {
    const inIframe = window.self !== window.top;
    let search = '';
    
    try {
        if (inIframe) {
            console.log('🔍 Detectado iframe, lendo URL da janela pai');
            search = window.parent.location.search;
        } else {
            search = window.location.search;
        }
    } catch (e) {
        console.warn('⚠️ Erro ao acessar parent:', e.message);
        search = window.location.search;
    }
    
    if (!search || search === '') {
        try {
            const href = inIframe ? window.parent.location.href : window.location.href;
            const questionMarkIndex = href.indexOf('?');
            if (questionMarkIndex !== -1) {
                search = href.substring(questionMarkIndex);
            }
        } catch (e) {
            console.warn('⚠️ Não conseguiu extrair params:', e.message);
        }
    }
    
    const params = new URLSearchParams(search);
    const result = {};
    for (const [key, value] of params) {
        if (value && value !== '') {
            result[key] = value;
        }
    }
    
    return result;
}

// ========== ENVIAR RESULTADO PARA BUBBLE ==========
function sendResultToBubble(resultado) {
    if (!BUBBLE_CONFIG.bubbleApiUrl || !BUBBLE_CONFIG.bubbleApiKey) {
        console.warn('⚠️ API Bubble não configurada');
        console.log('Resultado (não enviado):', resultado);
        return;
    }

    if (BUBBLE_CONFIG.bubbleApiKey.includes('%%')) {
        console.warn('⚠️ API Key placeholder - não enviando');
        return;
    }

    // Formatar dados para Bubble
    const bubbleData = {
        pagina: BUBBLE_CONFIG.paginaId,
        sessao: BUBBLE_CONFIG.sessaoId,
        aluno: BUBBLE_CONFIG.alunoId,
        pontos: resultado.pontosTotais || resultado.pontos || 0,
        acertos: resultado.acertos || 0,
        erros: resultado.erros || 0,
        percentual: resultado.percentualAcerto || resultado.percentual || 0,
        total_fases: resultado.totalFases || 0,
        detalhes: JSON.stringify(resultado.detalhes || []),
        data_jogo: resultado.timestamp || new Date().toISOString()
    };

    console.log('📤 Enviando para Bubble:', bubbleData);

    fetch(BUBBLE_CONFIG.bubbleApiUrl + '/obj/resultado_jogo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + BUBBLE_CONFIG.bubbleApiKey
        },
        body: JSON.stringify(bubbleData)
    })
    .then(response => {
        console.log('📥 Resposta HTTP:', response.status);
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('✅ Resultado salvo no Bubble!', data);
    })
    .catch(error => {
        console.error('❌ Erro ao enviar resultado:', error);
    });
}

// ========== TELA DE VITÓRIA BUBBLE ==========
function showVictoryBubble(resultado) {
    console.log('🎉 Mostrando tela de vitória Bubble...');
    
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.style.display = 'none';
    }
    
    const gameContainer = document.querySelector('.game-container');
    if (!gameContainer) {
        console.error('❌ game-container não encontrado!');
        return;
    }
    
    const victoryHTML = `
        <div id="victory-overlay" style="
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        ">
            <div style="
                background: white;
                border-radius: 30px;
                padding: 40px 50px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                text-align: center;
                max-width: 600px;
                animation: scaleIn 0.5s ease;
            ">
                <div style="font-size: 5rem; margin-bottom: 15px;">
                    🏆
                </div>
                <h1 style="
                    font-size: 2.5rem;
                    color: #ffd700;
                    margin-bottom: 15px;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
                ">
                    VITORIA!
                </h1>
                <p style="
                    font-size: 1.3rem;
                    color: #212529;
                    margin-bottom: 25px;
                ">
                    Voce completou todas as fases!
                </p>
                <div style="
                    background: rgba(102, 126, 234, 0.1);
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 25px;
                ">
                    <div style="margin-bottom: 15px;">
                        <span style="font-size: 1.2rem; font-weight: bold;">Pontos finais:</span>
                        <span style="font-size: 2rem; color: #ffd700; margin-left: 10px;">
                            ${resultado.pontosTotais || resultado.pontos || 0}
                        </span>
                    </div>
                    <div>
                        <span style="font-size: 1.2rem; font-weight: bold;">Acertos:</span>
                        <span style="font-size: 2rem; color: #51cf66; margin-left: 10px;">
                            ${resultado.acertos || 0}
                        </span>
                    </div>
                </div>
                <button id="btn-voltar" style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    padding: 20px 50px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    border-radius: 50px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    transition: transform 0.3s ease;
                    margin-bottom: 20px;
                ">
                    🏠 VOLTAR
                </button>
                <div id="countdown" style="font-size: 1rem; opacity: 0.6;">
                    Voltando automaticamente em <span id="seconds">10</span>s
                </div>
            </div>
        </div>
        
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes scaleIn {
                from { transform: scale(0.8); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            #btn-voltar:hover {
                transform: translateY(-3px) scale(1.05);
            }
        </style>
    `;
    
    gameContainer.insertAdjacentHTML('beforeend', victoryHTML);
    
    // Event listener para botão VOLTAR
    const btnVoltar = document.getElementById('btn-voltar');
    if (btnVoltar) {
        btnVoltar.addEventListener('click', function() {
            console.log('🏠 Botão VOLTAR clicado');
            window.location.href = '/index/7';
        });
    }
    
    // Auto-redirect após 10 segundos
    let seconds = 10;
    const countdownInterval = setInterval(function() {
        seconds--;
        const secondsEl = document.getElementById('seconds');
        if (secondsEl) {
            secondsEl.textContent = seconds;
        }
        
        if (seconds <= 0) {
            clearInterval(countdownInterval);
            console.log('⏱️ Tempo esgotado - redirecionando para /index/7');
            window.location.href = '/index/7';
        }
    }, 1000);
}

// ========== INICIALIZAÇÃO ==========
function setupBubbleIntegration() {
    console.log('🔗 Inicializando parâmetros Bubble...');
    initBubbleParams();
    
    // Fazer override IMEDIATAMENTE
    overrideGameEngineFinish();
}

// ========== OVERRIDE DO GAME ENGINE ==========
// Wrapper que intercepta o finish() SEMPRE
function overrideGameEngineFinish() {
    // Criar um interval que verifica se GAME_ENGINE existe
    const checkInterval = setInterval(function() {
        if (window.GAME_ENGINE && typeof window.GAME_ENGINE.finish === 'function') {
            clearInterval(checkInterval);
            
            console.log('✅ GAME_ENGINE encontrado! Aplicando override Bubble...');
            
            // Guardar referência ao método original
            const originalFinish = GAME_ENGINE.finish;
            
            // Sobrescrever com versão Bubble
            GAME_ENGINE.finish = function() {
                console.log('🏁 JOGO FINALIZADO (MODO BUBBLE)!');
                
                const resultado = this.getFinalResult();
                console.log('📊 Resultado:', resultado);
                
                // Enviar para Bubble
                console.log('📤 Tentando enviar para Bubble...');
                sendResultToBubble(resultado);
                
                // Mostrar tela Bubble
                console.log('🎉 Mostrando tela de vitória Bubble...');
                showVictoryBubble(resultado);
                
                return resultado;
            };
            
            console.log('✅ Game Engine.finish() SOBRESCRITO para modo Bubble');
        }
    }, 50); // Verifica a cada 50ms
    
    // Timeout de segurança (10 segundos)
    setTimeout(function() {
        clearInterval(checkInterval);
    }, 10000);
}

// Inicializar assim que possível
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupBubbleIntegration);
} else {
    setupBubbleIntegration();
}

console.log('🔗 bubble-integration.js carregado!');


            
            // ========== MECHANIC ==========
            // ===== MECÂNICA: ESCALADA =====
// Lume sobe uma montanha/torre conforme completa as fases

const ESCALADA = {
    name: 'escalada',
    currentStep: 0,
    totalSteps: 5, // Fase 0-4
    
    // Inicializar mecânica
    init: function(config) {
        console.log('🏔️ ESCALADA.init() chamado com config:', config);
        
        if (!config || !config.totalSteps) {
            console.error('❌ ERRO: config.totalSteps não fornecido!');
            return;
        }
        
        this.totalSteps = config.totalSteps;
        this.currentStep = 0;
        
        console.log('✅ Mecânica ESCALADA inicializada');
        console.log('   Total de andares (totalSteps):', this.totalSteps);
        console.log('   Andar atual (currentStep):', this.currentStep);
        console.log('   ✅ OPÇÃO A: 4 fases = 4 andares (BASE=0, ANDAR 1, ANDAR 2, TOPO=3)');
        console.log('   Andares a criar: BASE (0) até TOPO (' + (this.totalSteps - 1) + ')');
        
        this.injectHTML();
        this.injectCSS();
        this.updatePosition();
    },
    
    // Injetar HTML da montanha
    injectHTML: function() {
        const container = document.querySelector('.game-container');
        
        // Criar container da mecânica
        const mechanicHTML = `
            <div id="escalada-container" class="mechanic-container">
                <!-- Montanha com andares -->
                <div class="mountain">
                    ${this.generateFloors()}
                </div>
                
                <!-- Lume escalador -->
                <div id="lume-climber" class="lume-climber">
                    🌟
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', mechanicHTML);
    },
    
    // Gerar andares da montanha
    generateFloors: function() {
        console.log('🏭️ Gerando andares da montanha...');
        console.log('   Criando', this.totalSteps, 'andares (BASE=0 até TOPO=' + (this.totalSteps - 1) + ')');
        
        let floorsHTML = '';
        
        // ✅ Loop de (totalSteps - 1) até 0
        for (let i = this.totalSteps - 1; i >= 0; i--) {
            const floorNumber = i;
            
            // ✅ Label: BASE para 0, "ANDAR X" para os outros
            const floorLabel = i === 0 ? 'BASE' : `ANDAR ${i}`;
            
            // ✅ Topo é o último andar (totalSteps - 1)
            const isTop = i === this.totalSteps - 1;
            
            console.log('   Criando:', floorLabel, '(índice', i + ')', isTop ? '🏆 TOPO' : '');
            
            floorsHTML += `
                <div class="floor" data-floor="${floorNumber}">
                    <div class="floor-platform ${isTop ? 'top' : ''}">
                        <span class="floor-label">${floorLabel}</span>
                        ${isTop ? '<span class="victory-flag">🚩</span>' : ''}
                    </div>
                </div>
            `;
        }
        
        console.log('✅ Todos os', this.totalSteps, 'andares gerados!');
        return floorsHTML;
    },
    
    // Injetar CSS
    injectCSS: function() {
        if (document.getElementById('escalada-styles')) return;
        
        // ✅ Calcular altura dinâmica dos andares
        const numAndares = this.totalSteps; // OPÇÃO A: totalSteps = número de andares
        const floorHeightPercent = 100 / numAndares;
        
        console.log('🎨 Criando CSS com', numAndares, 'andares, altura de cada:', floorHeightPercent + '%');
        
        const style = document.createElement('style');
        style.id = 'escalada-styles';
        style.textContent = `
            /* Container da mecânica */
            #escalada-container {
                position: fixed;
                right: 40px;
                top: 100px;
                bottom: 40px;
                width: 200px;
                z-index: 100;
                pointer-events: none;
            }
            
            /* Montanha */
            .mountain {
                position: relative;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            
            /* Andar - ✅ ALTURA DINÂMICA */
            .floor {
                position: relative;
                height: ${floorHeightPercent}%; /* Calculado dinamicamente! */
                display: flex;
                align-items: flex-end;
                justify-content: center;
            }
            
            /* Plataforma do andar */
            .floor-platform {
                width: 100%;
                height: 40px;
                background: linear-gradient(to bottom, #8b7355, #654321);
                border-radius: 10px 10px 0 0;
                border: 3px solid #5a3a1a;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                transition: all 0.3s ease;
            }
            
            .floor-platform:hover {
                transform: scale(1.05);
            }
            
            /* Plataforma do topo (vitória) */
            .floor-platform.top {
                background: linear-gradient(to bottom, #ffd700, #ff8c00);
                border-color: #cc6600;
                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);
            }
            
            /* Label do andar */
            .floor-label {
                font-size: 0.7rem;
                font-weight: bold;
                color: white;
                text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
                letter-spacing: 1px;
            }
            
            /* Bandeira de vitória */
            .victory-flag {
                position: absolute;
                top: -30px;
                font-size: 2rem;
                animation: wave 1s ease-in-out infinite;
            }
            
            @keyframes wave {
                0%, 100% { transform: rotate(-10deg); }
                50% { transform: rotate(10deg); }
            }
            
            /* Lume escalador - CORRIGIDO */
            .lume-climber {
                position: absolute;
                left: 50%;
                bottom: 0;
                transform: translateX(-50%);
                font-size: 3rem;
                filter: drop-shadow(0 0 20px #fff8dc);
                transition: bottom 1s cubic-bezier(0.68, -0.55, 0.265, 1.55), 
                            transform 0.3s ease;
                z-index: 101;
                pointer-events: none;
            }
            
            /* Animação de subida */
            .lume-climber.climbing {
                animation: climb 1s ease-in-out;
            }
            
            @keyframes climb {
                0%, 100% { transform: translateX(-50%) scale(1); }
                25% { transform: translateX(-50%) scale(1.2) rotate(-10deg); }
                50% { transform: translateX(-50%) scale(1.1) rotate(5deg); }
                75% { transform: translateX(-50%) scale(1.2) rotate(-5deg); }
            }
            
            /* Shake animation */
            @keyframes shake {
                0%, 100% { transform: translateX(-50%) translateY(0); }
                25% { transform: translateX(-50%) translateY(-10px); }
                50% { transform: translateX(-50%) translateY(5px); }
                75% { transform: translateX(-50%) translateY(-5px); }
            }
            
            /* Partículas ao subir */
            .climb-particle {
                position: absolute;
                width: 10px;
                height: 10px;
                background: #ffd700;
                border-radius: 50%;
                pointer-events: none;
                animation: particleRise 1s ease-out forwards;
            }
            
            @keyframes particleRise {
                0% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-100px) scale(0);
                }
            }
            
            /* Responsivo */
            @media (max-width: 768px) {
                #escalada-container {
                    right: 10px;
                    top: 80px;
                    width: 120px;
                }
                
                .floor-platform {
                    height: 30px;
                }
                
                .floor-label {
                    font-size: 0.6rem;
                }
                
                .lume-climber {
                    font-size: 2rem;
                }
                
                .victory-flag {
                    font-size: 1.5rem;
                    top: -25px;
                }
            }
        `;
        
        document.head.appendChild(style);
    },
    
    // Atualizar posição do Lume - CORRIGIDO
    updatePosition: function() {
        const lume = document.getElementById('lume-climber');
        if (!lume) return;
        
        // Calcular posição (0 = base, 4 = topo)
        // Lume fica EM CIMA da plataforma
        const floorHeight = 100 / this.totalSteps;
        const platformHeight = 40; // Altura da plataforma em px
        const lumeOffset = 20; // Ajuste fino para centralizar
        
        const bottomPosition = (this.currentStep * floorHeight);
        
        // Posicionar em cima da plataforma
        lume.style.bottom = `calc(${bottomPosition}% + ${platformHeight - lumeOffset}px)`;
        
        console.log(`🏔️ Lume no andar ${this.currentStep}/${this.totalSteps - 1}`);
    },
    
    // Subir um andar (quando acerta)
    climb: function() {
        console.log('⬆️ climb() chamado. Andar atual:', this.currentStep, '/ Total:', this.totalSteps);
        
        if (this.currentStep >= this.totalSteps - 1) {
            console.log('🚫 Lume já está no topo! (andar', this.currentStep, '=', this.totalSteps - 1, ')');
            return;
        }
        
        this.currentStep++;
        console.log('✅ Subindo para andar', this.currentStep);
        
        // Adicionar classe de animação
        const lume = document.getElementById('lume-climber');
        lume.classList.add('climbing');
        
        // Criar partículas
        this.createParticles();
        
        // Atualizar posição
        this.updatePosition();
        
        // Remover classe após animação
        setTimeout(() => {
            lume.classList.remove('climbing');
        }, 1000);
        
        // VERIFICAÇÃO CORRETA: Chegou no topo?
        const isAtTop = this.currentStep === this.totalSteps - 1;
        console.log('🎯 Está no topo?', isAtTop, '(currentStep:', this.currentStep, '=== totalSteps-1:', this.totalSteps - 1, ')');
        
        if (isAtTop) {
            console.log('🎉 CHEGOU NO TOPO! Disparando efeito de vitória...');
            setTimeout(() => {
                this.onReachTop();
            }, 1000);
        }
    },
    
    // Descer um andar (quando erra) - opcional
    fall: function() {
        if (this.currentStep <= 0) return;
        
        this.currentStep--;
        
        const lume = document.getElementById('lume-climber');
        lume.style.transform = 'translateX(-50%) scale(0.8)';
        
        this.updatePosition();
        
        setTimeout(() => {
            lume.style.transform = 'translateX(-50%) scale(1)';
        }, 300);
    },
    
    // Criar partículas ao subir
    createParticles: function() {
        const lume = document.getElementById('lume-climber');
        const rect = lume.getBoundingClientRect();
        
        for (let i = 0; i < 8; i++) {
            setTimeout(() => {
                const particle = document.createElement('div');
                particle.className = 'climb-particle';
                particle.style.left = (rect.left + rect.width / 2) + 'px';
                particle.style.top = (rect.top + rect.height / 2) + 'px';
                particle.style.position = 'fixed';
                
                // Posição aleatória
                const angle = (Math.random() - 0.5) * 180;
                particle.style.setProperty('--angle', angle + 'deg');
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }, i * 50);
        }
    },
    
    // Quando chega no topo
    onReachTop: function() {
        console.log('🎉 Lume chegou no topo!');
        
        const lume = document.getElementById('lume-climber');
        lume.style.transform = 'translateX(-50%) scale(1.5)';
        
        // Efeito de vitória
        this.createVictoryEffect();
    },
    
    // Efeito de vitória
    createVictoryEffect: function() {
        for (let i = 0; i < 20; i++) {
            setTimeout(() => {
                const particle = document.createElement('div');
                particle.textContent = '⭐';
                particle.style.position = 'fixed';
                particle.style.right = '140px';
                particle.style.top = '100px';
                particle.style.fontSize = '2rem';
                particle.style.zIndex = '1000';
                particle.style.pointerEvents = 'none';
                particle.style.animation = `particleRise ${1 + Math.random()}s ease-out forwards`;
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 2000);
            }, i * 100);
        }
    },
    
    // Feedback de acerto
    onCorrect: function() {
        console.log('✅ Resposta correta! Subindo...');
        this.climb();
    },
    
    // Feedback de erro
    onWrong: function() {
        console.log('❌ Resposta errada!');
        // Não desce, só não sobe
        
        // Shake effect
        const lume = document.getElementById('lume-climber');
        lume.style.animation = 'shake 0.5s';
        setTimeout(() => {
            lume.style.animation = '';
        }, 500);
    },
    
    // Resetar mecânica
    reset: function() {
        this.currentStep = 0;
        this.updatePosition();
        
        const lume = document.getElementById('lume-climber');
        if (lume) {
            lume.style.transform = 'translateX(-50%) scale(1)';
        }
    },
    
    // Destruir mecânica
    destroy: function() {
        const container = document.getElementById('escalada-container');
        if (container) {
            container.remove();
        }
        
        const styles = document.getElementById('escalada-styles');
        if (styles) {
            styles.remove();
        }
    }
};

// Expor globalmente
window.ESCALADA = ESCALADA;

console.log('🏔️ escalada.js carregado!');

            
            // ========== MODALITIES ==========
            
// ===== quiz.js =====
// ===== MODALIDADE: QUIZ =====
// Múltipla escolha com 4 alternativas

const QUIZ = {
    name: 'quiz',
    currentQuestion: null,
    
    // Criar UI do quiz
    createUI: function(data) {
        const container = document.createElement('div');
        container.className = 'quiz-container';
        
        // Pergunta
        const questionBox = document.createElement('div');
        questionBox.className = 'quiz-question';
        questionBox.innerHTML = `
            <div class="question-icon">❓</div>
            <div class="question-text">${data.pergunta}</div>
        `;
        container.appendChild(questionBox);
        
        // Alternativas
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'quiz-options';
        
        data.alternativas.forEach((alternativa, index) => {
            const button = document.createElement('button');
            button.className = 'quiz-option';
            
            // Letras A, B, C, D
            const letter = String.fromCharCode(65 + index);
            button.innerHTML = `
                <span class="option-letter">${letter}</span>
                <span class="option-text">${alternativa}</span>
            `;
            
            button.setAttribute('data-index', index);
            
            // ✅ Usar bind(this) para manter contexto correto
            button.onclick = this.selectOption.bind(this, index, data.correta, data);
            
            optionsContainer.appendChild(button);
        });
        
        container.appendChild(optionsContainer);
        
        // Injetar CSS se ainda não foi
        this.injectCSS();
        
        this.currentQuestion = data;
        
        return container;
    },
    
    // Selecionar opção
    selectOption: function(selectedIndex, correctIndex, data) {
        const isCorrect = selectedIndex === correctIndex;
        
        // ✅ PEGAR SOMENTE botões da fase ATIVA (não de todas as fases!)
        const currentPhase = document.querySelector('.phase.active');
        if (!currentPhase) {
            console.error('❌ Fase ativa não encontrada!');
            return;
        }
        
        const buttons = currentPhase.querySelectorAll('.quiz-option');
        
        console.log('🎯 Resposta selecionada:', selectedIndex, '| Correta:', correctIndex, '| Acertou:', isCorrect);
        console.log('🔘 Desabilitando', buttons.length, 'botões da fase atual');
        
        // Desabilitar todos os botões DA FASE ATUAL
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
        });
        
        // Marcar resposta selecionada
        const selectedButton = buttons[selectedIndex];
        const correctButton = buttons[correctIndex];
        
        if (isCorrect) {
            // ACERTOU
            selectedButton.classList.add('correct');
            selectedButton.style.opacity = '1';

            // Feedback
            const feedbackMsg = data.feedback_correto || '✅ Correto! Muito bem!';
            showFeedback(feedbackMsg, 'correct');
            playSound('success');

        } else {
            // ERROU
            selectedButton.classList.add('wrong');
            selectedButton.style.opacity = '1';

            // Mostrar resposta correta após 500ms
            setTimeout(() => {
                correctButton.classList.add('correct');
                correctButton.style.opacity = '1';
            }, 500);

            // Feedback
            const feedbackMsg = data.feedback_errado || '❌ Ops! A resposta correta era a alternativa ' + String.fromCharCode(65 + correctIndex);
            showFeedback(feedbackMsg, 'wrong');
            playSound('error');
        }

        // ✅ CHAMAR CALLBACK CENTRAL (registra no Game Engine, anima mecânica, avança fase)
        const phaseNumber = window.gameState ? window.gameState.currentPhase : 1;

        if (window.onAnswerChecked) {
            onAnswerChecked(isCorrect, phaseNumber);
        } else {
            console.error('❌ onAnswerChecked não encontrado! Verifique se base.js foi carregado.');
        }
    },
    
    // Injetar CSS
    injectCSS: function() {
        if (document.getElementById('quiz-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'quiz-styles';
        style.textContent = `
            /* Container do Quiz */
            .quiz-container {
                max-width: 700px;
                margin: 0 auto;
                padding: 20px;
            }
            
            /* Pergunta */
            .quiz-question {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
                border: 3px solid #667eea;
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            .question-icon {
                font-size: 3rem;
                margin-bottom: 15px;
                animation: bounce 2s ease-in-out infinite;
            }
            
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }
            
            .question-text {
                font-size: 1.4rem;
                font-weight: 600;
                color: #212529;
                line-height: 1.6;
            }
            
            /* Alternativas */
            .quiz-options {
                display: grid;
                gap: 15px;
            }
            
            .quiz-option {
                display: flex;
                align-items: center;
                padding: 20px 25px;
                background: white;
                border: 3px solid #dee2e6;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: left;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            
            .quiz-option:hover:not(:disabled) {
                transform: translateX(10px);
                border-color: #667eea;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                background: linear-gradient(to right, #ffffff, #f8f9ff);
            }
            
            .quiz-option:active:not(:disabled) {
                transform: translateX(5px);
            }
            
            /* Letra da alternativa */
            .option-letter {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
                border-radius: 50%;
                margin-right: 20px;
                flex-shrink: 0;
                transition: transform 0.3s ease;
            }
            
            .quiz-option:hover:not(:disabled) .option-letter {
                transform: scale(1.2) rotate(10deg);
            }
            
            /* Texto da alternativa */
            .option-text {
                font-size: 1.1rem;
                font-weight: 500;
                color: #212529;
                line-height: 1.5;
            }
            
            /* Estado: Correta */
            .quiz-option.correct {
                background: linear-gradient(135deg, #51cf66, #38d9a9);
                border-color: #37b24d;
                animation: correctPulse 0.6s ease;
            }
            
            .quiz-option.correct .option-letter {
                background: #2f9e44;
            }
            
            .quiz-option.correct .option-text {
                color: white;
                font-weight: 700;
            }
            
            @keyframes correctPulse {
                0%, 100% { transform: scale(1) translateX(0); }
                50% { transform: scale(1.03) translateX(10px); }
            }
            
            /* Estado: Errada */
            .quiz-option.wrong {
                background: linear-gradient(135deg, #ff6b6b, #ff8787);
                border-color: #f03e3e;
                animation: wrongShake 0.5s ease;
            }
            
            .quiz-option.wrong .option-letter {
                background: #c92a2a;
            }
            
            .quiz-option.wrong .option-text {
                color: white;
                font-weight: 700;
            }
            
            @keyframes wrongShake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                50% { transform: translateX(10px); }
                75% { transform: translateX(-5px); }
            }
            
            /* Responsivo */
            @media (max-width: 768px) {
                .quiz-container {
                    padding: 15px;
                }
                
                .quiz-question {
                    padding: 20px;
                }
                
                .question-icon {
                    font-size: 2.5rem;
                }
                
                .question-text {
                    font-size: 1.1rem;
                }
                
                .quiz-option {
                    padding: 15px 20px;
                }
                
                .option-letter {
                    width: 35px;
                    height: 35px;
                    font-size: 1rem;
                    margin-right: 15px;
                }
                
                .option-text {
                    font-size: 1rem;
                }
            }
        `;
        
        document.head.appendChild(style);
    }
};

// Expor globalmente
window.QUIZ = QUIZ;

console.log('📝 quiz.js carregado!');


// ===== true-false.js =====
// ===== MODALIDADE: VERDADEIRO OU FALSO =====
// Afirmações para julgar como verdadeiras ou falsas

const TRUE_FALSE = {
    name: 'true-false',
    currentQuestion: null,
    
    // Criar UI
    createUI: function(data) {
        const container = document.createElement('div');
        container.className = 'true-false-container';
        
        // Afirmação
        const statementBox = document.createElement('div');
        statementBox.className = 'tf-statement';
        statementBox.innerHTML = `
            <div class="statement-icon">🤔</div>
            <div class="statement-text">${data.afirmacao}</div>
        `;
        container.appendChild(statementBox);
        
        // Botões V ou F
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'tf-buttons';
        
        // Botão VERDADEIRO
        const trueButton = document.createElement('button');
        trueButton.className = 'tf-button tf-true';
        trueButton.innerHTML = `
            <div class="tf-icon">✓</div>
            <div class="tf-label">VERDADEIRO</div>
        `;
        trueButton.onclick = () => this.selectOption(true, data.correta, data);
        
        // Botão FALSO
        const falseButton = document.createElement('button');
        falseButton.className = 'tf-button tf-false';
        falseButton.innerHTML = `
            <div class="tf-icon">✗</div>
            <div class="tf-label">FALSO</div>
        `;
        falseButton.onclick = () => this.selectOption(false, data.correta, data);
        
        buttonsContainer.appendChild(trueButton);
        buttonsContainer.appendChild(falseButton);
        container.appendChild(buttonsContainer);
        
        // Injetar CSS
        this.injectCSS();
        
        this.currentQuestion = data;
        
        return container;
    },
    
    // Selecionar opção
    selectOption: function(selectedValue, correctValue, data) {
        const isCorrect = selectedValue === correctValue;
        const buttons = document.querySelectorAll('.tf-button');
        
        console.log('🎯 Resposta:', selectedValue, '| Correta:', correctValue, '| Acertou:', isCorrect);
        
        // Desabilitar botões
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.6';
        });
        
        // Marcar botão selecionado
        const selectedButton = selectedValue ? buttons[0] : buttons[1];
        const correctButton = correctValue ? buttons[0] : buttons[1];
        
        if (isCorrect) {
            // ACERTOU
            selectedButton.classList.add('correct');
            selectedButton.style.opacity = '1';

            const feedbackMsg = data.feedback_correto || '✅ Correto!';
            showFeedback(feedbackMsg, 'correct');
            playSound('success');

        } else {
            // ERROU
            selectedButton.classList.add('wrong');
            selectedButton.style.opacity = '1';

            // Mostrar resposta correta
            setTimeout(() => {
                correctButton.classList.add('correct');
                correctButton.style.opacity = '1';
            }, 500);

            const feedbackMsg = data.feedback_errado || '❌ Incorreto! A resposta é ' + (correctValue ? 'VERDADEIRO' : 'FALSO');
            showFeedback(feedbackMsg, 'wrong');
            playSound('error');
        }

        // ✅ CHAMAR CALLBACK CENTRAL (registra no Game Engine, anima mecânica, avança fase)
        const phaseNumber = window.gameState ? window.gameState.currentPhase : 1;

        if (window.onAnswerChecked) {
            onAnswerChecked(isCorrect, phaseNumber);
        } else {
            console.error('❌ onAnswerChecked não encontrado! Verifique se base.js foi carregado.');
        }
    },
    
    // Injetar CSS
    injectCSS: function() {
        if (document.getElementById('true-false-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'true-false-styles';
        style.textContent = `
            /* Container */
            .true-false-container {
                max-width: 700px;
                margin: 0 auto;
                padding: 20px;
            }
            
            /* Afirmação */
            .tf-statement {
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
                border: 3px solid #667eea;
                border-radius: 20px;
                padding: 40px;
                margin-bottom: 40px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            .statement-icon {
                font-size: 4rem;
                margin-bottom: 20px;
                animation: thinking 2s ease-in-out infinite;
            }
            
            @keyframes thinking {
                0%, 100% { transform: rotate(-5deg); }
                50% { transform: rotate(5deg); }
            }
            
            .statement-text {
                font-size: 1.6rem;
                font-weight: 600;
                color: #212529;
                line-height: 1.8;
            }
            
            /* Botões */
            .tf-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }
            
            .tf-button {
                padding: 40px 30px;
                background: white;
                border: 4px solid #dee2e6;
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .tf-button:hover:not(:disabled) {
                transform: translateY(-10px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            }
            
            .tf-button:active:not(:disabled) {
                transform: translateY(-5px);
            }
            
            /* Botão Verdadeiro */
            .tf-true {
                border-color: #51cf66;
            }
            
            .tf-true:hover:not(:disabled) {
                background: linear-gradient(to bottom, #ffffff, #d3f9d8);
                border-color: #37b24d;
            }
            
            .tf-true .tf-icon {
                font-size: 4rem;
                font-weight: bold;
                color: #37b24d;
            }
            
            .tf-true .tf-label {
                font-size: 1.4rem;
                font-weight: 700;
                color: #2f9e44;
            }
            
            /* Botão Falso */
            .tf-false {
                border-color: #ff6b6b;
            }
            
            .tf-false:hover:not(:disabled) {
                background: linear-gradient(to bottom, #ffffff, #ffe0e0);
                border-color: #f03e3e;
            }
            
            .tf-false .tf-icon {
                font-size: 4rem;
                font-weight: bold;
                color: #f03e3e;
            }
            
            .tf-false .tf-label {
                font-size: 1.4rem;
                font-weight: 700;
                color: #c92a2a;
            }
            
            /* Estado: Correto */
            .tf-button.correct {
                background: linear-gradient(135deg, #51cf66, #38d9a9);
                border-color: #2f9e44;
                animation: correctPulse 0.6s ease;
            }
            
            .tf-button.correct .tf-icon,
            .tf-button.correct .tf-label {
                color: white;
            }
            
            @keyframes correctPulse {
                0%, 100% { transform: scale(1) translateY(0); }
                50% { transform: scale(1.05) translateY(-10px); }
            }
            
            /* Estado: Errado */
            .tf-button.wrong {
                background: linear-gradient(135deg, #ff6b6b, #ff8787);
                border-color: #c92a2a;
                animation: wrongShake 0.5s ease;
            }
            
            .tf-button.wrong .tf-icon,
            .tf-button.wrong .tf-label {
                color: white;
            }
            
            @keyframes wrongShake {
                0%, 100% { transform: translateX(0) translateY(0); }
                25% { transform: translateX(-15px) translateY(-5px); }
                50% { transform: translateX(15px) translateY(-5px); }
                75% { transform: translateX(-10px) translateY(-5px); }
            }
            
            /* Responsivo */
            @media (max-width: 768px) {
                .true-false-container {
                    padding: 15px;
                }
                
                .tf-statement {
                    padding: 25px;
                }
                
                .statement-icon {
                    font-size: 3rem;
                }
                
                .statement-text {
                    font-size: 1.2rem;
                }
                
                .tf-buttons {
                    gap: 20px;
                }
                
                .tf-button {
                    padding: 30px 20px;
                }
                
                .tf-icon {
                    font-size: 3rem !important;
                }
                
                .tf-label {
                    font-size: 1.1rem !important;
                }
            }
        `;
        
        document.head.appendChild(style);
    }
};

// Expor globalmente
window.TRUE_FALSE = TRUE_FALSE;

console.log('✓✗ true-false.js carregado!');

// ===== fill-blanks.js =====
const FILL_BLANKS = {
    name: 'fill-blanks',
    
    createUI: function(data) {
        const container = document.createElement('div');
        container.className = 'fill-blanks-container';
        container.innerHTML = `
            <div class="fb-header">
                <div class="fb-icon">✏️</div>
                <div class="fb-title">Complete a frase:</div>
            </div>
            <div class="fb-sentence">
                ${data.frase.replace('____', '<input type="text" class="fb-input" id="fb-answer" placeholder="?" autocomplete="off">')}
            </div>
            ${data.dica ? `<div class="fb-hint">💡 Dica: ${data.dica}</div>` : ''}
            <button class="fb-button">✓ CONFIRMAR</button>
        `;
        
        this.injectCSS();
        
        setTimeout(() => {
            const input = document.getElementById('fb-answer');
            const button = container.querySelector('.fb-button');
            if (input) input.focus();
            if (button) button.onclick = () => this.checkAnswer(data);
            if (input) input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.checkAnswer(data);
            });
        }, 100);
        
        return container;
    },
    
    checkAnswer: function(data) {
        const input = document.getElementById('fb-answer');
        const button = document.querySelector('.fb-button');
        if (!input || !button) return;
        
        const userAnswer = input.value.trim().toLowerCase();
        const correctAnswer = data.resposta.toLowerCase();
        const aceitas = data.variacoes_aceitas || [correctAnswer];
        const isCorrect = aceitas.some(v => userAnswer === v.toLowerCase());
        
        input.disabled = true;
        button.disabled = true;
        
        if (isCorrect) {
            input.classList.add('correct');
            button.classList.add('correct');
            showFeedback(data.feedback_correto || '✅ Correto!', 'correct');
            playSound('success');

        } else {
            input.classList.add('wrong');
            button.classList.add('wrong');
            setTimeout(() => {
                input.value = data.resposta;
                input.classList.remove('wrong');
                input.classList.add('show-correct');
            }, 800);
            showFeedback(data.feedback_errado || `❌ Resposta: ${data.resposta}`, 'wrong');
            playSound('error');
        }

        // ✅ CHAMAR CALLBACK CENTRAL (registra no Game Engine, anima mecânica, avança fase)
        const phaseNumber = window.gameState ? window.gameState.currentPhase : 1;

        if (window.onAnswerChecked) {
            onAnswerChecked(isCorrect, phaseNumber);
        } else {
            console.error('❌ onAnswerChecked não encontrado! Verifique se base.js foi carregado.');
        }
    },
    
    injectCSS: function() {
        if (document.getElementById('fill-blanks-styles')) return;
        const style = document.createElement('style');
        style.id = 'fill-blanks-styles';
        style.textContent = `
            .fill-blanks-container { max-width: 700px; margin: 0 auto; padding: 20px; }
            .fb-header { text-align: center; margin-bottom: 30px; }
            .fb-icon { font-size: 3.5rem; margin-bottom: 10px; }
            .fb-title { font-size: 1.3rem; font-weight: 600; color: #495057; }
            .fb-sentence { background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border: 3px solid #667eea; border-radius: 20px; padding: 40px; margin-bottom: 30px; font-size: 1.8rem; font-weight: 600; color: #212529; line-height: 2.5; text-align: center; }
            .fb-input { display: inline-block; min-width: 150px; padding: 10px 20px; font-size: 1.8rem; font-weight: 700; text-align: center; border: 3px solid #667eea; border-radius: 10px; background: white; color: #212529; outline: none; }
            .fb-input:focus { border-color: #5a67d8; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); transform: scale(1.05); }
            .fb-input.correct { background: linear-gradient(135deg, #51cf66, #38d9a9); border-color: #37b24d; color: white; }
            .fb-input.wrong { background: linear-gradient(135deg, #ff6b6b, #ff8787); border-color: #f03e3e; color: white; animation: shake 0.5s; }
            .fb-input.show-correct { background: linear-gradient(135deg, #51cf66, #38d9a9); border-color: #37b24d; color: white; }
            @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-5px); } }
            .fb-hint { background: rgba(255, 193, 7, 0.15); border-left: 4px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin-bottom: 30px; font-size: 1rem; color: #856404; }
            .fb-button { width: 100%; padding: 20px; font-size: 1.3rem; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
            .fb-button:hover:not(:disabled) { transform: translateY(-3px); }
            .fb-button:disabled { opacity: 0.6; cursor: not-allowed; }
            .fb-button.correct { background: linear-gradient(135deg, #51cf66, #38d9a9); }
            .fb-button.wrong { background: linear-gradient(135deg, #ff6b6b, #ff8787); }
        `;
        document.head.appendChild(style);
    }
};

window.FILL_BLANKS = FILL_BLANKS;
console.log('✏️ fill-blanks.js carregado!');

// ===== sequence.js =====
// ===== MODALIDADE: ORDENAR SEQUENCIA (DRAG AND DROP) =====

const SEQUENCE = {
    name: 'sequence',
    currentQuestion: null,
    currentOrder: [],
    draggedIndex: null,
    
    createUI: function(data) {
        const container = document.createElement('div');
        container.className = 'sequence-container';
        
        const headerBox = document.createElement('div');
        headerBox.className = 'seq-header';
        headerBox.innerHTML = '<div class="seq-icon">123</div><div class="seq-title">Arraste para ordenar:</div>';
        container.appendChild(headerBox);
        
        if (data.instrucao) {
            const instrBox = document.createElement('div');
            instrBox.className = 'seq-instruction';
            instrBox.textContent = data.instrucao;
            container.appendChild(instrBox);
        }
        
        this.currentOrder = this.shuffle([...data.itens]);
        
        const listBox = document.createElement('div');
        listBox.className = 'seq-list';
        listBox.id = 'seq-list';
        
        this.renderList(listBox, this.currentOrder);
        container.appendChild(listBox);
        
        const button = document.createElement('button');
        button.className = 'seq-button';
        button.textContent = 'CONFIRMAR ORDEM';
        button.onclick = () => this.checkAnswer(data);
        container.appendChild(button);
        
        this.injectCSS();
        this.currentQuestion = data;
        
        return container;
    },
    
    renderList: function(listBox, items) {
        listBox.innerHTML = '';
        
        items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'seq-item';
            itemDiv.draggable = true;
            itemDiv.dataset.index = index;
            
            // Eventos de drag
            itemDiv.addEventListener('dragstart', (e) => this.handleDragStart(e, index));
            itemDiv.addEventListener('dragover', (e) => this.handleDragOver(e));
            itemDiv.addEventListener('drop', (e) => this.handleDrop(e, index));
            itemDiv.addEventListener('dragend', (e) => this.handleDragEnd(e));
            
            const number = document.createElement('div');
            number.className = 'seq-number';
            number.textContent = index + 1;
            
            const text = document.createElement('div');
            text.className = 'seq-text';
            text.textContent = item;
            
            const dragIcon = document.createElement('div');
            dragIcon.className = 'seq-drag-icon';
            dragIcon.innerHTML = '&#8801;';
            
            itemDiv.appendChild(number);
            itemDiv.appendChild(text);
            itemDiv.appendChild(dragIcon);
            
            listBox.appendChild(itemDiv);
        });
    },
    
    handleDragStart: function(e, index) {
        this.draggedIndex = index;
        e.currentTarget.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        playSound('click');
    },
    
    handleDragOver: function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    },
    
    handleDrop: function(e, dropIndex) {
        e.preventDefault();
        e.stopPropagation();
        
        if (this.draggedIndex === null || this.draggedIndex === dropIndex) {
            return;
        }
        
        // Reordenar array
        const draggedItem = this.currentOrder[this.draggedIndex];
        this.currentOrder.splice(this.draggedIndex, 1);
        this.currentOrder.splice(dropIndex, 0, draggedItem);
        
        // Re-renderizar
        const listBox = document.getElementById('seq-list');
        this.renderList(listBox, this.currentOrder);
        
        playSound('click');
    },
    
    handleDragEnd: function(e) {
        e.currentTarget.classList.remove('dragging');
        this.draggedIndex = null;
    },
    
    shuffle: function(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            const temp = arr[i];
            arr[i] = arr[j];
            arr[j] = temp;
        }
        return arr;
    },
    
    checkAnswer: function(data) {
        const button = document.querySelector('.seq-button');
        const items = document.querySelectorAll('.seq-item');
        
        button.disabled = true;
        
        // Desabilitar drag
        items.forEach(item => {
            item.draggable = false;
            item.style.cursor = 'default';
        });
        
        const isCorrect = JSON.stringify(this.currentOrder) === JSON.stringify(data.ordem_correta);
        
        if (isCorrect) {
            items.forEach(item => item.classList.add('correct'));
            button.classList.add('correct');

            showFeedback(data.feedback_correto || 'Perfeito!', 'correct');
            playSound('success');

        } else {
            items.forEach(item => item.classList.add('wrong'));
            button.classList.add('wrong');

            setTimeout(() => {
                items.forEach(item => item.classList.remove('wrong'));
                this.currentOrder = [...data.ordem_correta];
                const listBox = document.getElementById('seq-list');
                this.renderList(listBox, this.currentOrder);

                const newItems = document.querySelectorAll('.seq-item');
                newItems.forEach(item => {
                    item.classList.add('show-correct');
                    item.draggable = false;
                    item.style.cursor = 'default';
                });
            }, 1000);

            showFeedback(data.feedback_errado || 'Ops! Veja a ordem correta.', 'wrong');
            playSound('error');
        }

        // ✅ CHAMAR CALLBACK CENTRAL (registra no Game Engine, anima mecânica, avança fase)
        const phaseNumber = window.gameState ? window.gameState.currentPhase : 1;

        if (window.onAnswerChecked) {
            onAnswerChecked(isCorrect, phaseNumber);
        } else {
            console.error('❌ onAnswerChecked não encontrado! Verifique se base.js foi carregado.');
        }
    },
    
    injectCSS: function() {
        if (document.getElementById('sequence-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'sequence-styles';
        style.textContent = `
            .sequence-container { max-width: 700px; margin: 0 auto; padding: 20px; }
            .seq-header { text-align: center; margin-bottom: 30px; }
            .seq-icon { font-size: 3.5rem; margin-bottom: 10px; }
            .seq-title { font-size: 1.3rem; font-weight: 600; color: #495057; }
            .seq-instruction { background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; border-radius: 8px; padding: 15px 20px; margin-bottom: 30px; font-size: 1rem; color: #495057; font-weight: 500; }
            .seq-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
            
            .seq-item { 
                background: white; 
                border: 3px solid #dee2e6; 
                border-radius: 15px; 
                padding: 15px 20px; 
                display: flex; 
                align-items: center; 
                gap: 15px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
                cursor: grab;
                transition: all 0.2s ease;
                user-select: none;
            }
            
            .seq-item:hover {
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
                transform: translateY(-2px);
            }
            
            .seq-item:active {
                cursor: grabbing;
            }
            
            .seq-item.dragging {
                opacity: 0.5;
                cursor: grabbing;
                transform: rotate(3deg);
            }
            
            .seq-number { 
                background: linear-gradient(135deg, #667eea, #764ba2); 
                color: white; 
                width: 40px; 
                height: 40px; 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-weight: 700; 
                font-size: 1.2rem;
                flex-shrink: 0;
            }
            
            .seq-text { 
                flex: 1; 
                font-size: 1.1rem; 
                font-weight: 600; 
                color: #212529; 
            }
            
            .seq-drag-icon {
                font-size: 1.5rem;
                color: #adb5bd;
                cursor: grab;
                flex-shrink: 0;
            }
            
            .seq-item:active .seq-drag-icon {
                cursor: grabbing;
            }
            
            .seq-item.correct { 
                background: linear-gradient(135deg, #d3f9d8, #b2f2bb); 
                border-color: #51cf66;
                animation: correctPulse 0.6s ease;
            }
            
            .seq-item.correct .seq-number { 
                background: linear-gradient(135deg, #51cf66, #38d9a9); 
            }
            
            .seq-item.wrong { 
                background: linear-gradient(135deg, #ffe0e0, #ffc9c9); 
                border-color: #ff6b6b; 
                animation: shake 0.5s; 
            }
            
            .seq-item.show-correct { 
                background: linear-gradient(135deg, #d3f9d8, #b2f2bb); 
                border-color: #51cf66; 
            }
            
            .seq-item.show-correct .seq-number { 
                background: linear-gradient(135deg, #51cf66, #38d9a9); 
            }
            
            @keyframes correctPulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
            
            @keyframes shake { 
                0%, 100% { transform: translateX(0); } 
                25% { transform: translateX(-10px); } 
                50% { transform: translateX(10px); } 
                75% { transform: translateX(-5px); } 
            }
            
            .seq-button { 
                width: 100%; 
                padding: 20px; 
                font-size: 1.3rem; 
                font-weight: 700; 
                background: linear-gradient(135deg, #667eea, #764ba2); 
                color: white; 
                border: none; 
                border-radius: 15px; 
                cursor: pointer; 
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); 
                transition: all 0.3s ease;
            }
            
            .seq-button:hover:not(:disabled) { 
                transform: translateY(-3px); 
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }
            
            .seq-button:disabled { 
                opacity: 0.6; 
                cursor: not-allowed; 
            }
            
            .seq-button.correct { 
                background: linear-gradient(135deg, #51cf66, #38d9a9); 
            }
            
            .seq-button.wrong { 
                background: linear-gradient(135deg, #ff6b6b, #ff8787); 
            }
        `;
        
        document.head.appendChild(style);
    }
};

window.SEQUENCE = SEQUENCE;
console.log('sequence.js carregado com drag and drop!');

            
            // ========== GAME DATA ==========
            const GAME_CONFIG = {
  "tema": "🧪 Teste Completo - IAlume Factory",
  "descricao": "Teste integrado: 4 modalidades + escalada + Bubble + callback central",
  "mecanica": "escalada",
  "fases": [
    {
      "type": "welcome"
    },
    {
      "modalidade": "quiz",
      "dados": {
        "pergunta": "🧮 Qual é o resultado de 7 × 8?",
        "alternativas": [
          "54",
          "56",
          "63",
          "72"
        ],
        "correta": 1,
        "feedback_correto": "✅ Perfeito! 7 × 8 = 56",
        "feedback_errado": "❌ Ops! A resposta correta é 56."
      }
    },
    {
      "modalidade": "true-false",
      "dados": {
        "afirmacao": "🌍 A Terra gira ao redor do Sol.",
        "correta": true,
        "feedback_correto": "✅ Correto! A Terra orbita o Sol!",
        "feedback_errado": "❌ Na verdade, isso é verdadeiro! A Terra orbita o Sol."
      }
    },
    {
      "modalidade": "fill-blanks",
      "dados": {
        "frase": "🦖 Os dinossauros viveram na Era ____.",
        "resposta": "Mesozoica",
        "variacoes_aceitas": [
          "mesozoica",
          "Mesozoica",
          "mesozóica",
          "Mesozóica"
        ],
        "dica": "Começou há cerca de 252 milhões de anos",
        "feedback_correto": "✅ Isso mesmo! Era Mesozoica!",
        "feedback_errado": "❌ A resposta correta é Mesozoica."
      }
    },
    {
      "modalidade": "sequence",
      "dados": {
        "instrucao": "🔢 Ordene os planetas do mais próximo ao mais distante do Sol:",
        "itens": [
          "Saturno",
          "Terra",
          "Mercúrio",
          "Marte"
        ],
        "ordem_correta": [
          "Mercúrio",
          "Terra",
          "Marte",
          "Saturno"
        ],
        "feedback_correto": "✅ Perfeito! Ordem planetária correta!",
        "feedback_errado": "❌ Ops! Veja a ordem correta dos planetas."
      }
    }
  ]
};
            
            // ========== INITIALIZATION ==========
            window.totalPhases = 5;
            
            console.log('🎮 Inicializando jogo...');
            console.log('📊 Total de fases:', window.totalPhases);
            console.log('📋 Config:', GAME_CONFIG);
            
            // Aguardar DOM carregar
            window.addEventListener('DOMContentLoaded', function() {
                console.log('✅ DOM carregado!');
                
                // Verificar se Game Engine existe
                if (!window.GAME_ENGINE) {
                    console.error('❌ GAME_ENGINE não encontrado!');
                    alert('Erro: Game Engine não carregado!');
                    return;
                }
                
                // Verificar se modalidades existem
                console.log('Modalidades disponíveis:', {
                    QUIZ: typeof window.QUIZ,
                    TRUE_FALSE: typeof window.TRUE_FALSE,
                    FILL_BLANKS: typeof window.FILL_BLANKS,
                    SEQUENCE: typeof window.SEQUENCE
                });
                
                // Inicializar jogo
                console.log('🚀 Iniciando Game Engine...');
                GAME_ENGINE.init(GAME_CONFIG);
            });
        
    </script>
</body>
</html>